<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Rediscover ATK SPD Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css">
</head>
<body class="theme-Primal">
<header><h1>Rediscover ATK SPD Calculator</h1></header>
<main>
  <div class="card"><div class="inner">
    <h2>Base & Buffs</h2>
    <div class="section">
      <div class="row">
        <label>Class</label>
        <div class="seg" id="classSeg">
          <button type="button" data-val="Berserker">Berserker</button>
          <button type="button" data-val="Paladin">Paladin</button>
          <button type="button" data-val="Ranger">Ranger</button>
          <button type="button" data-val="Sorcerer" class="is-active">Sorcerer</button>
        </div>
        <select id="cls" class="hidden"></select>
      </div>
      <div class="row">
        <label>Weapon</label>
        <div class="seg" id="weaponSeg">
          <button type="button" data-val="Original" class="is-active">Original</button>
          <button type="button" data-val="Primal">Primal</button>
          <button type="button" data-val="Chaos">Chaos</button>
          <button type="button" data-val="Abyss">Abyss</button>
          <button type="button" data-val="PvP/Boss">PvP/Boss</button>
        </div>
        <select id="weap" class="hidden"></select>
      </div>
      <div class="row"><label>Equipment ATK SPD</label><input id="equip" type="number" value="0"></div>
      <div class="row"><label>Rune ATK SPD</label><input id="rune" type="number" value="0"></div>
      <div class="row"><label>Pet Gear</label><select id="pet"><option value="None">None</option><option value="B">B</option><option value="A">A</option><option value="S">S</option></select></div>
    </div>
    <div class="stats">
      <div class="stat"><label>Required ATK SPD</label><input id="requiredBox" type="number" readonly></div>
      <div class="stat"><label>Final ATK SPD</label><input id="finalBox" type="number" readonly></div>
    </div>
  </div></div>
  <div class="card"><div class="inner">
    <h2>Optimizer</h2>
    <button class="btn" id="applyBest">Apply Optimal</button>
    <div id="bestLine"></div>
    <div id="bestWaste"></div>
    <h2>Alternates</h2><ul id="altList"></ul>
  </div></div>
</main>
<footer>Guild – <strong>Rediscover Alliance</strong> | Creator – <strong>SAGE</strong></footer>
<script>
let rules=null;
async function loadRules(){const res=await fetch('gearRules.json');rules=await res.json();init();recalc();}
loadRules();

const els=(ids=>ids.reduce((o,id)=>(o[id]=document.getElementById(id),o),{}))(
 ["cls","weap","equip","rune","pet","requiredBox","finalBox","bestLine","bestWaste","altList","applyBest"]
);

// Restore seg button wiring
function wireSeg(segId, selectEl){
  const seg=document.getElementById(segId);
  seg?.addEventListener('click',e=>{
    const btn=e.target.closest('button'); if(!btn) return;
    seg.querySelectorAll('button').forEach(b=>b.classList.remove('is-active'));
    btn.classList.add('is-active');
    selectEl.value=btn.dataset.val;
    recalc();
  });
}

function init(){
  // Build select options
  ["Berserker","Paladin","Ranger","Sorcerer"].forEach(v=>{
    if(!els.cls.querySelector(`option[value='${v}']`)){
      const o=document.createElement('option');o.value=v;o.text=v;els.cls.appendChild(o);
    }
  });
  ["Original","Primal","Chaos","Abyss","PvP/Boss"].forEach(v=>{
    if(!els.weap.querySelector(`option[value='${v}']`)){
      const o=document.createElement('option');o.value=v;o.text=v;els.weap.appendChild(o);
    }
  });
  els.cls.value="Sorcerer"; els.weap.value="Original";
  wireSeg('classSeg', els.cls); wireSeg('weaponSeg', els.weap);
}

function currentState(){
  if(!rules) return {};
  const cls=els.cls.value; const weap=els.weap.value;
  const baseSpd=rules.base_speeds[weap][cls];
  const equip=parseFloat(els.equip.value||0)/100;
  const rune=parseFloat(els.rune.value||0)/100;
  const pet=rules.pet_as_bonus[els.pet.value]||0;
  const buffsAll=equip+rune+pet;
  const denom=baseSpd;
  const requiredTotal=1-(rules.target_final_interval/denom);
  const requiredRemaining=Math.max(0,requiredTotal-buffsAll);
  const finalRaw=baseSpd*(1-buffsAll);
  const finalSpd=Math.max(finalRaw,rules.target_final_interval);
  return {cls,weap,baseSpd,equip,rune,pet,buffsAll,requiredTotal,requiredRemaining,finalSpd};
}

function planCombos(){
  if(!rules) return [];
  const s=currentState(); const chosen=s.weap;
  const pieceVal=rules.atkspd_values[chosen]; if(!pieceVal) return [];
  const need=Math.max(0,s.requiredTotal);
  const results=[];
  for(let pieces=0;pieces<=8;pieces++){
    const equipPct=pieces*pieceVal;
    for(const [petName,petV] of Object.entries(rules.pet_as_bonus)){
      const coverage=equipPct+petV;
      if(coverage>=need){
        const waste=coverage-need;
        results.push({set:chosen,pieces,equipPct,pet:petName,petV,total:coverage,waste});
        break;
      }
    }
  }
  results.sort((a,b)=>(a.pieces-b.pieces)||(b.petV-a.petV)||(a.waste-b.waste));
  return results.slice(0,5);
}

let lastBest=null;
function recalc(){
  if(!rules) return;
  const s=currentState();
  els.requiredBox.value=(s.requiredRemaining*100).toFixed(2);
  els.finalBox.value=s.finalSpd.toFixed(2);
  const plans=planCombos();
  if(plans.length){
    lastBest=plans[0];
    els.bestLine.textContent=`${plans[0].set}: ${plans[0].pieces} pieces → ${(plans[0].total*100).toFixed(2)}%`;
    els.bestWaste.textContent=`Waste: ${(plans[0].waste*100).toFixed(2)}%`;
    els.altList.innerHTML=plans.slice(1).map(r=>`<li>${r.set}: ${r.pieces} pcs — waste ${(r.waste*100).toFixed(2)}%</li>`).join('');
  } else {
    els.bestLine.textContent='No valid combo'; els.bestWaste.textContent='—'; els.altList.innerHTML=''; lastBest=null;
  }
}

function applyOptimal(){
  if(!lastBest) return alert('No optimal combo yet');
  els.equip.value=(lastBest.equipPct*100).toFixed(2);
  els.pet.value=lastBest.pet;
  recalc();
}
els.applyBest?.addEventListener('click',applyOptimal);
['input','change','click'].forEach(evt=>document.addEventListener(evt,e=>{if(e.target.matches('input,select,button')) recalc();}));
</script>
</body>
</html>